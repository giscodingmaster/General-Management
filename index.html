<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام إدارة عمليات غاز مصر</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- React & Dependencies via Import Map -->
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.294.0",
    "recharts": "https://esm.sh/recharts@2.10.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0"
  }
}
</script>
  
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Animations */
    .animate-in { animation-duration: 0.5s; animation-fill-mode: both; }
    .fade-in { animation-name: fadeIn; }
    .slide-in-up { animation-name: slideUp; }
    .slide-in-right { animation-name: slideRight; }
    .delay-100 { animation-delay: 100ms; }
    .delay-200 { animation-delay: 200ms; }
    .delay-300 { animation-delay: 300ms; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes slideRight { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Glassmorphism Utils */
    .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
    .glass-dark { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      LayoutDashboard, ClipboardList, Settings, Menu, Map as MapIcon, ChevronDown, Calendar,
      Sparkles, Save, X, Search, Users, Truck, Briefcase, Car, Drill, Bus, Ban,
      Lock, Unlock, Filter, Building, MapPin, XCircle, Clock, Check, ChevronLeft, ChevronRight,
      ChevronUp, Trophy, Medal, Crown, Activity, AlertTriangle, FileBarChart, Zap, Loader2,
      TrendingUp, ArrowRightLeft, Target, List, ArrowUpRight, FileText, Navigation
    } from 'lucide-react';
    import { 
      PieChart, Pie, Cell, ResponsiveContainer, Tooltip as RechartsTooltip 
    } from 'recharts';

    // --- TYPES & CONSTANTS ---
    
    const EmployeeStatus = {
      ABSENT: 'ABSENT',
      OFFICE: 'OFFICE',
      SITE: 'SITE',
    };

    const AREAS = [
      { id: 'Cairo', name: 'القاهرة' },
      { id: 'Gharbia', name: 'الغربية' },
      { id: 'Dakahlia', name: 'الدقهلية' },
      { id: 'Menoufia', name: 'المنوفية' },
      { id: 'Alexandria', name: 'الإسكندرية' },
    ];

    const MOCK_EMPLOYEES = [
      { id: '1', name: 'أحمد سليمان', role: 'مهندس أول', department: 'Company', avatar: 'https://i.pravatar.cc/150?u=1', status: 'OFFICE', areaId: 'Cairo' },
      { id: '2', name: 'وليد محي', role: 'مسّاح', department: 'Institute', avatar: 'https://i.pravatar.cc/150?u=2', status: 'ABSENT', areaId: 'Cairo' },
      { id: '3', name: 'أشرف إبراهيم', role: 'فني تشغيل', department: 'Institute', avatar: 'https://i.pravatar.cc/150?u=3', status: 'OFFICE', areaId: 'Gharbia' },
      { id: '4', name: 'محمد فرج', role: 'سائق', department: 'Company', avatar: 'https://i.pravatar.cc/150?u=4', status: 'SITE', areaId: 'Cairo' },
      { id: '5', name: 'ندى سامح', role: 'مدير عمليات', department: 'Company', avatar: 'https://i.pravatar.cc/150?u=5', status: 'OFFICE', areaId: 'Cairo' },
      { id: '6', name: 'خالد علي', role: 'مسؤول سلامة', department: 'Institute', avatar: 'https://i.pravatar.cc/150?u=6', status: 'OFFICE', areaId: 'Gharbia' },
      { id: '7', name: 'يوسف كمال', role: 'فني لحام', department: 'Company', avatar: 'https://i.pravatar.cc/150?u=7', status: 'SITE', areaId: 'Cairo' },
    ];

    const MOCK_ASSETS = [
      { id: 'c1', name: 'تويوتا هايلكس', type: 'CAR', details: 'لوحة: ر هـ ي ٣٩٧', assigned: false, areaId: 'Cairo' },
      { id: 'c2', name: 'نيسان دبل كابينة', type: 'CAR', details: 'لوحة: أ ب ج ١٢٣', assigned: false, areaId: 'Gharbia' },
      { id: 'e1', name: 'جهاز توتال ستيشن', type: 'EQUIPMENT', details: 'SN: 3216763', assigned: false, areaId: 'Cairo' },
      { id: 'e2', name: 'لايكا TS07', type: 'EQUIPMENT', details: 'SN: 3222517', assigned: false, areaId: 'Gharbia' },
    ];

    const MOCK_TASKS = [
      {
        id: 't1', title: 'صيانة خط شبرا', description: 'صيانة دورية للخط الرئيسي رقم ٤',
        date: new Date().toISOString().split('T')[0], areaId: 'Cairo', status: 'IN_PROGRESS',
        teamCount: 4, assetCount: 2, assignedEmployees: ['1', '4'], assignedAssets: ['c1', 'e1']
      },
      {
        id: 't2', title: 'تركيبات المحلة الكبرى', description: 'تركيب وصلات منزلية لقطاع ب',
        date: new Date(Date.now() + 86400000).toISOString().split('T')[0], areaId: 'Gharbia', status: 'PENDING',
        teamCount: 6, assetCount: 3, assignedEmployees: ['3'], assignedAssets: ['c2']
      }
    ];

    // --- MOCK SERVICES ---
    const generateTaskDescription = async (title, assetCount, peopleCount) => {
      await new Promise(r => setTimeout(r, 1500));
      return `وصف تلقائي للمهمة: ${title}. سيتم العمل باستخدام ${assetCount} معدات وبواسطة فريق مكون من ${peopleCount} أفراد. يرجى الالتزام بمعايير السلامة المهنية وتحديث الحالة فور الوصول للموقع.`;
    };

    const generateManagerReport = async (date, type, data) => {
      await new Promise(r => setTimeout(r, 2000));
      return `تقرير الأداء ليوم ${date}:\nتتصدر منطقة القاهرة بنسبة حضور 92%، بينما تحتاج الغربية لمراجعة توزيع المركبات. العمليات تسير بشكل مستقر ولا توجد حوادث مبلغ عنها.`;
    };

    const generateDetailedReport = async (areaName) => {
      await new Promise(r => setTimeout(r, 2000));
      return `
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-right border border-slate-200">
            <thead class="bg-slate-100 text-slate-700">
              <tr>
                <th class="px-4 py-2 border">الاسم</th>
                <th class="px-4 py-2 border">الوظيفة</th>
                <th class="px-4 py-2 border">الحالة</th>
                <th class="px-4 py-2 border">وقت الحضور</th>
              </tr>
            </thead>
            <tbody>
              <tr><td class="px-4 py-2 border">أحمد سليمان</td><td class="px-4 py-2 border">مهندس</td><td class="px-4 py-2 border bg-green-50 text-green-700">حضور</td><td class="px-4 py-2 border">08:00</td></tr>
              <tr><td class="px-4 py-2 border">وليد محي</td><td class="px-4 py-2 border">مساح</td><td class="px-4 py-2 border bg-red-50 text-red-700">غياب</td><td class="px-4 py-2 border">-</td></tr>
            </tbody>
          </table>
        </div>
      `;
    };

    // --- COMPONENTS ---

    // 1. Employee Row (Ultimate Style)
    const EmployeeRow = ({ employee, onChangeStatus, isBusy, busyTaskTitle, isOverride }) => {
      const disabled = isBusy && !isOverride;

      return (
        <div className={`group relative flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl shadow-sm mb-3 transition-all duration-300 hover:shadow-md hover:border-blue-100 ${disabled ? 'opacity-60 bg-slate-50' : ''}`}>
          <div className="flex items-center gap-4">
            <div className="relative">
                 <div className={`w-12 h-12 rounded-2xl overflow-hidden border-2 transition-colors ${isBusy ? 'border-amber-300 grayscale' : 'border-white shadow-sm'}`}>
                    <img src={employee.avatar} alt={employee.name} className="w-full h-full object-cover" />
                 </div>
                 {isBusy && (
                     <div className="absolute -bottom-1 -right-1 bg-amber-100 text-amber-600 rounded-full p-1 border-2 border-white shadow-sm z-10">
                         <Clock size={10} strokeWidth={3} />
                     </div>
                 )}
                 <div className={`absolute top-0 right-0 w-3 h-3 rounded-full border-2 border-white shadow-sm ${
                     employee.status === 'SITE' ? 'bg-blue-500' : 
                     employee.status === 'OFFICE' ? 'bg-amber-500' : 'bg-red-500'
                 }`}></div>
            </div>
            
            <div>
              <h4 className={`font-bold text-slate-800 flex items-center gap-2 ${isBusy ? 'text-slate-600' : ''}`}>
                {employee.name}
                {isBusy && <span className="px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 text-[10px] font-bold border border-amber-100">في مهمة</span>}
              </h4>
              <p className="text-xs text-slate-500 mt-0.5 font-medium flex items-center gap-1.5">
                <span className="w-1 h-1 rounded-full bg-slate-300"></span>
                {employee.role}
                <span className="w-1 h-1 rounded-full bg-slate-300"></span>
                <span className="text-slate-400">{employee.department === 'Company' ? 'الشركة' : 'المعهد'}</span>
              </p>
              {isBusy && <p className="text-[10px] text-amber-600 mt-1">مشغول في: {busyTaskTitle}</p>}
            </div>
          </div>

          <div className={`p-1 bg-slate-100/80 rounded-xl flex items-center gap-1 ${disabled ? 'pointer-events-none opacity-50' : ''}`}>
            <button
              onClick={() => onChangeStatus(employee.id, 'ABSENT')}
              className={`relative px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 flex items-center gap-1.5 ${
                employee.status === 'ABSENT' ? 'bg-white text-red-600 shadow-sm ring-1 ring-black/5' : 'text-slate-400 hover:text-slate-600 hover:bg-slate-200/50'
              }`}
            >
              <XCircle size={14} className={employee.status === 'ABSENT' ? "fill-red-100" : ""} />
              <span className={employee.status === 'ABSENT' ? "" : "hidden lg:inline"}>غياب</span>
            </button>

            <button
              onClick={() => onChangeStatus(employee.id, 'OFFICE')}
              className={`relative px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 flex items-center gap-1.5 ${
                employee.status === 'OFFICE' ? 'bg-white text-amber-600 shadow-sm ring-1 ring-black/5' : 'text-slate-400 hover:text-slate-600 hover:bg-slate-200/50'
              }`}
            >
              <Building size={14} className={employee.status === 'OFFICE' ? "fill-amber-100" : ""} />
              <span className={employee.status === 'OFFICE' ? "" : "hidden lg:inline"}>مكتب</span>
            </button>

            <button
              onClick={() => onChangeStatus(employee.id, 'SITE')}
              className={`relative px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 flex items-center gap-1.5 ${
                employee.status === 'SITE' ? 'bg-blue-600 text-white shadow-md shadow-blue-200' : 'text-slate-400 hover:text-slate-600 hover:bg-slate-200/50'
              }`}
            >
              {employee.status === 'SITE' && <Check size={14} strokeWidth={3} />}
              <MapPin size={14} />
              <span>موقع</span>
            </button>
          </div>
        </div>
      );
    };

    // 2. Asset Card
    const AssetCard = ({ asset, selected, onToggle, customIcon, isBusy, busyTaskTitle, isOverride }) => {
      const disabled = isBusy && !isOverride;
      
      let theme = { base: '', selected: '', iconBox: '', check: '', title: '' };
      
      if (asset.id === 'transport-mode') {
        theme = {
          base: 'hover:border-emerald-300 hover:bg-emerald-50/30',
          selected: 'bg-emerald-50 border-emerald-500 ring-1 ring-emerald-500',
          iconBox: selected ? 'bg-emerald-200 text-emerald-800' : 'bg-emerald-100 text-emerald-600',
          check: 'bg-emerald-500',
          title: selected ? 'text-emerald-900' : 'text-slate-700'
        };
      } else if (asset.type === 'EQUIPMENT') {
        theme = {
          base: 'hover:border-amber-300 hover:bg-amber-50/30',
          selected: 'bg-amber-50 border-amber-500 ring-1 ring-amber-500',
          iconBox: selected ? 'bg-amber-200 text-amber-800' : 'bg-amber-100 text-amber-600',
          check: 'bg-amber-500',
          title: selected ? 'text-amber-900' : 'text-slate-700'
        };
      } else {
        theme = {
          base: 'hover:border-blue-300 hover:bg-blue-50/30',
          selected: 'bg-blue-50 border-blue-500 ring-1 ring-blue-500',
          iconBox: selected ? 'bg-blue-200 text-blue-800' : 'bg-blue-100 text-blue-600',
          check: 'bg-blue-500',
          title: selected ? 'text-blue-900' : 'text-slate-700'
        };
      }

      return (
        <div 
          onClick={() => !disabled && onToggle(asset.id)}
          className={`relative group flex flex-col justify-between p-3 rounded-xl border transition-all duration-200 cursor-pointer ${
            disabled ? 'opacity-70 bg-slate-50 border-slate-200 cursor-not-allowed' : (selected ? theme.selected : `bg-white border-slate-200 ${theme.base}`)
          }`}
        >
          {isBusy && !selected && <div className="absolute top-2 left-2 text-amber-500 animate-pulse"><Clock size={14} /></div>}
          <div className="flex justify-between items-start mb-2">
            <div className={`p-2 rounded-lg transition-colors ${theme.iconBox}`}>
              {customIcon ? customIcon : (asset.type === 'CAR' ? <Car size={18} /> : <Drill size={18} />)}
            </div>
            {selected && !disabled && <div className={`${theme.check} text-white rounded-full p-0.5`}><Check size={12} /></div>}
          </div>
          <div>
            <h5 className={`text-sm font-semibold transition-colors ${theme.title}`}>{asset.name}</h5>
            <p className="text-xs text-slate-500 truncate mt-1">
              {isBusy ? <span className="text-amber-600 flex items-center gap-1"> مشغول: {busyTaskTitle || 'مهمة'}</span> : asset.details}
            </p>
          </div>
        </div>
      );
    };

    // 3. Task Entry Screen
    const TaskEntry = ({ areaName, availableAssets, availableEmployees, tasks, onSave, onCancel }) => {
      const [title, setTitle] = useState('');
      const [description, setDescription] = useState('');
      const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
      const [employees, setEmployees] = useState(availableEmployees);
      const [enableOverride, setEnableOverride] = useState(false);
      const [selectedAssetIds, setSelectedAssetIds] = useState([]);
      const [searchEmployee, setSearchEmployee] = useState('');
      const [statusFilter, setStatusFilter] = useState('ALL');
      const [isGenerating, setIsGenerating] = useState(false);
      const [expandedGroups, setExpandedGroups] = useState({ cars: true, equipment: true });

      useEffect(() => setEmployees(availableEmployees), [availableEmployees]);

      // Collision Detection
      const busyMap = useMemo(() => {
        const busyA = new Set();
        const busyE = new Set();
        const busyETasks = {};
        const busyATasks = {};
        tasks.forEach(task => {
          if (task.date === date && task.status !== 'COMPLETED') {
            task.assignedAssets?.forEach(id => { busyA.add(id); busyATasks[id] = task.title; });
            task.assignedEmployees?.forEach(id => { busyE.add(id); busyETasks[id] = task.title; });
          }
        });
        return { busyA, busyE, busyETasks, busyATasks };
      }, [date, tasks]);

      const siteCount = employees.filter(e => e.status === 'SITE').length;
      const officeCount = employees.filter(e => e.status === 'OFFICE').length;
      const absentCount = employees.filter(e => e.status === 'ABSENT').length;
      
      const filteredEmployees = employees.filter(e => {
        const matchesSearch = e.name.toLowerCase().includes(searchEmployee.toLowerCase()) || e.role.toLowerCase().includes(searchEmployee.toLowerCase());
        const matchesFilter = statusFilter === 'ALL' || e.status === statusFilter;
        return matchesSearch && matchesFilter;
      });

      const handleStatusChange = (id, newStatus) => {
        if (busyMap.busyE.has(id) && !enableOverride) {
          alert(`هذا الموظف مشغول في مهمة "${busyMap.busyETasks[id]}".`); return;
        }
        setEmployees(prev => prev.map(e => e.id === id ? { ...e, status: newStatus } : e));
      };

      const handleAssetToggle = (id) => {
        if (busyMap.busyA.has(id) && !enableOverride) {
          alert(`هذا الأصل مشغول في مهمة "${busyMap.busyATasks[id]}".`); return;
        }
        setSelectedAssetIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
      };

      const handleSmartFill = async () => {
        if (!title) return alert("الاسم مطلوب");
        setIsGenerating(true);
        const desc = await generateTaskDescription(title, selectedAssetIds.length, siteCount);
        setDescription(desc);
        setIsGenerating(false);
      };

      return (
        <div className="max-w-7xl mx-auto space-y-6 animate-in fade-in pb-10">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
              <h1 className="text-2xl font-bold text-slate-900">مهمة تشغيل جديدة ({areaName})</h1>
              <p className="text-slate-500">تخصيص الموارد وإدارة الفريق.</p>
            </div>
            <div className="flex gap-3">
              <button onClick={() => setEnableOverride(!enableOverride)} className={`px-4 py-2 rounded-xl border text-sm flex items-center gap-2 ${enableOverride ? 'bg-amber-50 text-amber-700' : 'bg-white'}`}>
                {enableOverride ? <Unlock size={16}/> : <Lock size={16}/>} {enableOverride ? 'تجاوز' : 'حماية'}
              </button>
              <button onClick={onCancel} className="px-5 py-2 rounded-xl border bg-white hover:bg-slate-50">إلغاء</button>
              <button onClick={() => onSave({id: Date.now().toString(), title, description, date, areaId: employees[0]?.areaId, status: 'PENDING', teamCount: siteCount, assetCount: selectedAssetIds.length, assignedEmployees: employees.filter(e => e.status === 'SITE').map(e => e.id), assignedAssets: selectedAssetIds})} className="px-5 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 flex gap-2">
                <Save size={18} /> حفظ
              </button>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-1 space-y-6">
              <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                <h3 className="font-bold text-lg mb-4 text-blue-900 flex items-center gap-2"><Briefcase size={20}/> تفاصيل المهمة</h3>
                <div className="space-y-4">
                  <input value={title} onChange={e => setTitle(e.target.value)} placeholder="اسم المهمة" className="w-full px-4 py-2.5 rounded-lg border border-slate-200 outline-none focus:border-blue-500" />
                  <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full px-4 py-2.5 rounded-lg border border-slate-200 outline-none focus:border-blue-500" />
                  <div className="relative">
                    <button onClick={handleSmartFill} disabled={isGenerating} className="absolute left-2 top-2 text-xs text-purple-600 flex items-center gap-1 hover:bg-purple-50 p-1 rounded"><Sparkles size={12} /> مساعد ذكي</button>
                    <textarea value={description} onChange={e => setDescription(e.target.value)} rows={4} placeholder="الوصف..." className="w-full px-4 py-8 rounded-lg border border-slate-200 outline-none focus:border-blue-500 resize-none" />
                  </div>
                </div>
              </div>

              <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                <div className="flex justify-between mb-4">
                    <h3 className="font-bold text-lg text-blue-900 flex items-center gap-2"><Truck size={20}/> الأصول</h3>
                    <span className="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full">{selectedAssetIds.length}</span>
                </div>
                <div className="space-y-3 max-h-[400px] overflow-y-auto">
                    {availableAssets.map(asset => (
                        <AssetCard 
                            key={asset.id} 
                            asset={asset} 
                            selected={selectedAssetIds.includes(asset.id)}
                            onToggle={handleAssetToggle}
                            isBusy={busyMap.busyA.has(asset.id)}
                            busyTaskTitle={busyMap.busyATasks[asset.id]}
                            isOverride={enableOverride}
                        />
                    ))}
                </div>
              </div>
            </div>

            <div className="lg:col-span-2">
              <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm h-full flex flex-col">
                 <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h3 className="font-bold text-lg text-blue-900 flex items-center gap-2"><Users size={20}/> الفريق والحالة</h3>
                    <div className="flex bg-slate-50 p-1 rounded-xl border border-slate-100">
                        {['SITE', 'OFFICE', 'ABSENT'].map(status => (
                            <button key={status} onClick={() => setStatusFilter(status)} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${statusFilter === status ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>
                                {status === 'SITE' ? `موقع (${siteCount})` : status === 'OFFICE' ? `مكتب (${officeCount})` : `غياب (${absentCount})`}
                            </button>
                        ))}
                         {statusFilter !== 'ALL' && <button onClick={() => setStatusFilter('ALL')} className="px-2"><X size={14}/></button>}
                    </div>
                 </div>

                 <div className="relative mb-4">
                   <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                   <input value={searchEmployee} onChange={e => setSearchEmployee(e.target.value)} placeholder="بحث..." className="w-full pr-10 pl-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50 outline-none focus:bg-white focus:border-blue-500" />
                 </div>

                 <div className="flex-1 overflow-y-auto min-h-[400px]">
                    {filteredEmployees.map(emp => (
                        <EmployeeRow 
                            key={emp.id} 
                            employee={emp} 
                            onChangeStatus={handleStatusChange} 
                            isBusy={busyMap.busyE.has(emp.id)}
                            busyTaskTitle={busyMap.busyETasks[emp.id]}
                            isOverride={enableOverride}
                        />
                    ))}
                 </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // 4. Manager Dashboard
    const ManagerDashboard = ({ assets, employees }) => {
       const [showReport, setShowReport] = useState(false);
       const [loading, setLoading] = useState(false);
       const [reportContent, setReportContent] = useState('');

       const handleReport = async () => {
         setLoading(true);
         const text = await generateManagerReport('2023-10-27', 'daily', {});
         setReportContent(text);
         setLoading(false);
         setShowReport(true);
       };

       const data = [
          {name: 'موقع', value: 45, color: '#3B82F6'},
          {name: 'مكتب', value: 30, color: '#F59E0B'},
          {name: 'غياب', value: 5, color: '#EF4444'},
       ];

       return (
         <div className="p-4 space-y-8 animate-in fade-in">
            {/* Top Bar */}
            <div className="bg-white/90 backdrop-blur-xl p-4 rounded-3xl border border-white/50 flex flex-wrap justify-between items-center gap-4 shadow-sm sticky top-2 z-30">
               <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-slate-800 text-white rounded-2xl flex items-center justify-center shadow-lg"><Trophy size={24} className="text-yellow-400"/></div>
                  <div>
                     <h1 className="text-xl font-bold text-slate-900">لوحة الصدارة</h1>
                     <p className="text-xs text-green-500 font-bold">العمليات مستقرة</p>
                  </div>
               </div>
               <button onClick={handleReport} disabled={loading} className="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-200 flex items-center gap-2 hover:bg-indigo-700">
                  {loading ? <Loader2 className="animate-spin" size={16}/> : <FileText size={16}/>} تقرير ذكي
               </button>
            </div>

            {showReport && (
                <div className="bg-indigo-50 border border-indigo-100 p-6 rounded-3xl relative animate-in slide-in-up">
                    <button onClick={() => setShowReport(false)} className="absolute top-4 right-4 text-slate-400 hover:text-indigo-600"><X size={18}/></button>
                    <div className="flex items-center gap-2 mb-3 text-indigo-700 font-bold"><Zap size={20}/> تحليل AI</div>
                    <p className="text-slate-700 leading-relaxed whitespace-pre-line">{reportContent}</p>
                </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-end">
               {/* Podium Rank 2 */}
               <div className="order-2 lg:order-1 bg-white/80 backdrop-blur p-6 rounded-3xl border border-white shadow-xl hover:-translate-y-2 transition-transform cursor-pointer">
                  <div className="text-center">
                     <div className="inline-block p-3 bg-slate-50 rounded-2xl mb-3"><Medal size={32} className="text-slate-400"/></div>
                     <h2 className="text-xl font-bold text-slate-800">الغربية</h2>
                     <p className="text-sm text-slate-500">850 نقطة</p>
                     <div className="mt-4 flex justify-center gap-4 text-xs font-bold text-slate-700">
                        <span>92% حضور</span>
                        <span>5 مواقع</span>
                     </div>
                  </div>
               </div>
               {/* Podium Rank 1 */}
               <div className="order-1 lg:order-2 bg-gradient-to-b from-white to-amber-50 p-8 rounded-[2rem] border border-amber-100 shadow-2xl relative transform scale-105 z-10">
                  <div className="absolute -top-6 left-1/2 -translate-x-1/2"><Crown size={48} className="text-amber-400 drop-shadow-md" fill="#FBBF24"/></div>
                  <div className="text-center mt-6">
                     <span className="bg-amber-100 text-amber-800 text-[10px] font-bold px-3 py-1 rounded-full uppercase">Top Performance</span>
                     <h1 className="text-3xl font-black text-slate-900 mt-2">القاهرة</h1>
                     <div className="text-4xl font-bold text-amber-500 my-2">985</div>
                     <div className="flex justify-around mt-6 bg-white/50 p-3 rounded-xl">
                        <div><div className="text-[10px] text-slate-400">فريق</div><div className="font-bold">45</div></div>
                        <div><div className="text-[10px] text-slate-400">حضور</div><div className="font-bold">98%</div></div>
                     </div>
                  </div>
               </div>
               {/* Podium Rank 3 */}
               <div className="order-3 bg-white/80 backdrop-blur p-6 rounded-3xl border border-white shadow-xl hover:-translate-y-2 transition-transform cursor-pointer">
                  <div className="text-center">
                     <div className="inline-block p-3 bg-slate-50 rounded-2xl mb-3"><Medal size={32} className="text-orange-400"/></div>
                     <h2 className="text-xl font-bold text-slate-800">الإسكندرية</h2>
                     <p className="text-sm text-slate-500">820 نقطة</p>
                     <div className="mt-4 flex justify-center gap-4 text-xs font-bold text-slate-700">
                        <span>88% حضور</span>
                        <span>3 مواقع</span>
                     </div>
                  </div>
               </div>
            </div>

            {/* Charts Section */}
            <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                <h3 className="font-bold mb-6">توزيع القوى العاملة</h3>
                <div className="h-64">
                   <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                         <Pie data={data} innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                            {data.map((entry, index) => (
                               <Cell key={`cell-${index}`} fill={entry.color} strokeWidth={0} />
                            ))}
                         </Pie>
                         <RechartsTooltip />
                      </PieChart>
                   </ResponsiveContainer>
                </div>
                <div className="flex justify-center gap-4 mt-2">
                   {data.map(d => (
                       <div key={d.name} className="flex items-center gap-1 text-xs font-bold text-slate-600">
                          <span className="w-2 h-2 rounded-full" style={{background: d.color}}></span> {d.name}
                       </div>
                   ))}
                </div>
            </div>
         </div>
       );
    };

    // --- MAIN APP ---
    const App = () => {
      const [view, setView] = useState('DISPATCH');
      const [sidebarOpen, setSidebarOpen] = useState(true);
      const [selectedArea, setSelectedArea] = useState(AREAS[0]);
      
      // Global State
      const [assets, setAssets] = useState(MOCK_ASSETS);
      const [employees, setEmployees] = useState(MOCK_EMPLOYEES);
      const [tasks, setTasks] = useState(MOCK_TASKS);

      const areaAssets = assets.filter(a => a.areaId === selectedArea.id);
      const areaEmployees = employees.filter(e => e.areaId === selectedArea.id);

      const handleSaveTask = (newTask) => {
        setTasks(prev => [...prev, newTask]);
        setView('CALENDAR');
      };

      const SidebarItem = ({ icon, label, id }) => (
        <button onClick={() => setView(id)} className={`w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all ${view === id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
          {icon}
          {sidebarOpen && <span className="text-sm font-medium">{label}</span>}
        </button>
      );

      return (
        <div className="flex h-screen bg-slate-50 overflow-hidden text-slate-800">
          {/* Sidebar */}
          <aside className={`${sidebarOpen ? 'w-64' : 'w-20'} bg-slate-900 text-white flex flex-col transition-all duration-300 z-50 shadow-2xl`}>
             <div className="p-6 flex items-center gap-3 border-b border-slate-800">
                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold">غ</div>
                {sidebarOpen && <span className="font-bold text-lg">غاز مصر</span>}
             </div>
             
             {sidebarOpen && (
               <div className="px-4 py-4">
                 <div className="bg-slate-800 rounded-xl p-3 border border-slate-700">
                    <div className="flex items-center gap-2 text-blue-400 mb-2"><MapIcon size={14}/> <span className="text-xs font-bold">المنطقة الحالية</span></div>
                    <select 
                       value={selectedArea.id} 
                       onChange={e => setSelectedArea(AREAS.find(a => a.id === e.target.value))}
                       className="w-full bg-transparent text-sm font-bold outline-none text-white"
                    >
                       {AREAS.map(a => <option key={a.id} value={a.id} className="text-slate-900">{a.name}</option>)}
                    </select>
                 </div>
               </div>
             )}

             <nav className="flex-1 px-3 py-2 space-y-2">
               <SidebarItem id="DISPATCH" icon={<ClipboardList size={20}/>} label="مهمة جديدة" />
               <SidebarItem id="CALENDAR" icon={<Calendar size={20}/>} label="الجدول" />
               <SidebarItem id="MANAGER" icon={<LayoutDashboard size={20}/>} label="لوحة المدير" />
               <SidebarItem id="ASSETS" icon={<Settings size={20}/>} label="الموارد" />
             </nav>
          </aside>

          {/* Main Content */}
          <main className="flex-1 flex flex-col h-screen overflow-hidden relative bg-gradient-to-br from-slate-50 to-slate-100">
             <header className="h-16 bg-white/80 backdrop-blur border-b border-slate-200 flex items-center justify-between px-6 sticky top-0 z-40">
                <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 hover:bg-slate-100 rounded-lg"><Menu size={20}/></button>
                <div className="font-bold text-slate-700">{selectedArea.name}</div>
             </header>
             
             <div className="flex-1 overflow-auto p-4 md:p-8">
               {view === 'DISPATCH' && (
                 <TaskEntry 
                   areaName={selectedArea.name} 
                   availableAssets={areaAssets} 
                   availableEmployees={areaEmployees} 
                   tasks={tasks}
                   onSave={handleSaveTask}
                   onCancel={() => setView('CALENDAR')}
                 />
               )}
               {view === 'MANAGER' && <ManagerDashboard assets={assets} employees={employees} />}
               {view === 'CALENDAR' && (
                  <div className="text-center py-20">
                     <Calendar className="mx-auto text-slate-300 mb-4" size={48}/>
                     <h2 className="text-2xl font-bold text-slate-800">جدول المهام</h2>
                     <p className="text-slate-500 mb-6">تم حفظ {tasks.length} مهام في النظام.</p>
                     <button onClick={() => setView('DISPATCH')} className="bg-blue-600 text-white px-6 py-2 rounded-xl">إضافة مهمة</button>
                  </div>
               )}
               {view === 'ASSETS' && (
                  <div className="text-center py-20">
                     <Settings className="mx-auto text-slate-300 mb-4" size={48}/>
                     <h2 className="text-2xl font-bold text-slate-800">إدارة الموارد</h2>
                     <p className="text-slate-500">إدارة {assets.length} أصل و {employees.length} موظف.</p>
                  </div>
               )}
             </div>
          </main>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>